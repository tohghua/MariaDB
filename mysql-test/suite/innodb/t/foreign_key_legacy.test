--source include/mysql_upgrade_preparation.inc
--source include/have_innodb.inc
--source include/have_debug.inc
--source include/lcase_names.inc
--source suite/innodb/include/have_legacy_fk.inc

set default_storage_engine= innodb;
let $MYSQLD_DATADIR= `select @@datadir`;

call mtr.add_suppression("Couldn't repair table:");
set @saved_debug_dbug= @@session.debug_dbug;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
show create table t2;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;
flush tables;
--echo # Data is imported from SYS_FOREIGN[_COLS] on table open
# Warnings doesn't appear in SHOW CREATE TABLE under ps-protocol
--disable_warnings
show create table t2;
--enable_warnings

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

flush tables;
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--echo # DROP TABLE
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

--echo # DROP DATABASE (convert first)
create database D1;
create database D2;
create or replace table D1.t1(x int primary key);
set session debug_dbug= "+d,fk_skip_store";
create or replace table D2.t2(y int references D1.t1(x), x int primary key);
create or replace table D2.t4(x int primary key);
create or replace table D2.t3(y int references D2.t2(x), z int references D2.t4(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
# FK id must be lowercase as this is the format of SYS_FOREIGN
# Procedure DROP_DATABASE_PROC relies on that
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('d2/t2_ibfk_1', 'd2/t2', 'd1/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('d2/t3_ibfk_1', 'd2/t3', 'd2/t2', 1);
INSERT INTO SYS_FOREIGN VALUES ('d2/t3_ibfk_2', 'd2/t3', 'd2/t4', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t3_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t3_ibfk_2', 0, 'z', 'x');";
set session debug_dbug= @saved_debug_dbug;

--replace_result d1 D1 d2 D2
check table D1.t1, D2.t2;
--error ER_ROW_IS_REFERENCED_2
drop database D1;
--replace_result d1 D1 d2 D2
check table D1.t1, D2.t2;
drop database D2;
--replace_result d1 D1 d2 D2
check table D1.t1, D2.t2;
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
drop database D1;

--echo # DROP DATABASE (no conversion)
create database D1;
create database D2;
create or replace table D1.t1(x int primary key);
set session debug_dbug= "+d,fk_skip_store";
create or replace table D2.t2(y int references D1.t1(x), x int primary key);
create or replace table D2.t4(x int primary key);
create or replace table D2.t3(y int references D2.t2(x), z int references D2.t4(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('d2/t2_ibfk_1', 'd2/t2', 'd1/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('d2/t3_ibfk_1', 'd2/t3', 'd2/t2', 1);
INSERT INTO SYS_FOREIGN VALUES ('d2/t3_ibfk_2', 'd2/t3', 'd2/t4', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t3_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('d2/t3_ibfk_2', 0, 'z', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_ROW_IS_REFERENCED_2
drop database D1;
drop database D2;
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
drop database D1;


--echo # Index errors
create or replace table t1(x int primary key);
create or replace table t2(y int);

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;
flush tables;

--error ER_NOT_KEYFILE
show create table t2;
show warnings;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;
drop tables t2, t1;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(z int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_NOT_KEYFILE
show create table t2;
show warnings;
drop tables t2, t1;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(z int primary key);
create or replace table t2(y int references t1(z));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_NOT_KEYFILE
show create table t2;
show warnings;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;
drop tables t2, t1;

--echo # Rename of tables (RENAME TABLE)

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

rename table t1 to t0;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
--error ER_ROW_IS_REFERENCED_2
drop table t0;
drop tables t2, t0;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

rename table t2 to t3;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t3;
--enable_warnings

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t3, t1;

--echo # Rename of tables (ALTER TABLE .. RENAME)

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_ROW_IS_REFERENCED_2
alter table t1 rename t0, algorithm=copy;
alter table t1 rename t0, algorithm=inplace;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
drop tables t2, t0;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

alter table t2 rename t3;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

show create table t3;
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t3, t1;

--echo # Rename of columns (ALTER TABLE .. CHANGE)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_CANT_CREATE_TABLE
alter table t1 change x z int, algorithm=copy;
alter table t1 change x z int, algorithm=inplace;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
drop tables t2, t1;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_FK_COLUMN_CANNOT_DROP
alter table t2 change y z int, algorithm=copy;
alter table t2 change y z int, algorithm=inplace;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--echo # Rename of columns (ALTER TABLE .. RENAME COLUMN)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_CANT_CREATE_TABLE
alter table t1 rename column x to z, algorithm=copy;
alter table t1 rename column x to z, algorithm=inplace;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_FK_COLUMN_CANNOT_DROP
alter table t2 rename column y to z, algorithm=copy;
alter table t2 rename column y to z, algorithm=inplace;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--echo # Add column
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_CANT_CREATE_TABLE
alter table t1 add column z int, algorithm=copy;
--error ER_CANT_CREATE_TABLE
alter table t1 add column s int as (x) stored, algorithm=copy;
alter table t1 add column z int, algorithm=inplace;

select * from information_schema.innodb_sys_foreign;
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

alter table t1 add column s int as (x) stored, algorithm=copy;
show create table t2;
show create table t1;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

alter table t2 add column z int;
alter table t2 add column s int as (y) stored, algorithm=copy;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

--disable_warnings
show create table t2;
--enable_warnings

--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--echo # Drop column
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(a int primary key, x int unique);
create or replace table t2(y int references t1(x), b int);
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

--error ER_CANT_CREATE_TABLE
alter table t1 drop column x, algorithm=copy;
--error ER_CANT_CREATE_TABLE, ER_ALTER_OPERATION_NOT_SUPPORTED_REASON
alter table t1 change x x char(10);
--error ER_DROP_INDEX_FK
alter table t1 drop column x, algorithm=inplace;
--error ER_FK_NO_INDEX_CHILD
alter table t2 drop column y;

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

--error ER_ROW_IS_REFERENCED_2
drop table t1;
drop tables t2, t1;

--echo # Multi-threaded
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
create or replace table t3(y int references t1(x));
create or replace table t4(y int references t1(x));
create or replace table t5(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;

--connect (con1,localhost,root,,test)
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t3_ibfk_1', 'test/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t3_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t4_ibfk_1', 'test/t4', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t4_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN VALUES ('test/t5_ibfk_1', 'test/t5', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t5_ibfk_1', 0, 'y', 'x');";
set session debug_dbug= @saved_debug_dbug;

send check table t2;
--connect (con2,localhost,root,,test)
send check table t3;
--connect (con3,localhost,root,,test)
send check table t4;
--connection default
send check table t5;
--connection con1
reap;
--connection con2
reap;
--connection con3
reap;
--connection default
reap;

--disconnect con1
--disconnect con2
--disconnect con3

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
drop tables t5, t4, t3, t2, t1;

--echo # mysql_upgrade
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(a int primary key, x int unique);
create or replace table t2(y int references t1(x), b int);
create or replace table t3(z int references t1(a));
create database db0;
create database db1;
create or replace table db0.t2(y int references test.t1(x), b int);
create or replace table db0.t3(z int references test.t1(a));
create or replace table db1.t2(y int references test.t1(x), b int);
create or replace table db1.t3(z int references test.t1(a));
set session debug_dbug= @saved_debug_dbug;

set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('test/t3_ibfk_1', 'test/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db0/t2_ibfk_1', 'db0/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db0/t3_ibfk_1', 'db0/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db1/t2_ibfk_1', 'db1/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN VALUES ('db1/t3_ibfk_1', 'db1/t3', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t3_ibfk_1', 0, 'z', 'a');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db0/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db0/t3_ibfk_1', 0, 'z', 'a');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db1/t2_ibfk_1', 0, 'y', 'x');
INSERT INTO SYS_FOREIGN_COLS VALUES ('db1/t3_ibfk_1', 0, 'z', 'a');";
set session debug_dbug= @saved_debug_dbug;

set @saved_alter_algorithm= @@global.alter_algorithm;
set global alter_algorithm='COPY';
--exec $MYSQL_UPGRADE 2>&1
set global alter_algorithm=@saved_alter_algorithm;
--file_exists $MYSQLD_DATADIR/mariadb_upgrade_info
--remove_file $MYSQLD_DATADIR/mariadb_upgrade_info

--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;

show create table t1;
show create table t2;
show create table t3;
show create table db0.t2;
show create table db0.t3;
show create table db1.t2;
show create table db1.t3;
drop database db0;
drop database db1;
drop tables t3, t2, t1;

--echo # Replication: master old, slave new
--source include/master-slave.inc
--connection master
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key) engine innodb;
create or replace table t2(x int references t1(x)) engine innodb;
set session debug_dbug= @saved_debug_dbug;
--sync_slave_with_master
show create table t2;
--connection master
show create table t2;
flush tables t2;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
--error ER_NO_REFERENCED_ROW_2
insert t2 values (1);
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
alter table t1 rename column x to y, algorithm=inplace;
alter table t2 rename column x to y, algorithm=inplace;
show create table t2;
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
--sync_slave_with_master
show create table t2;
--connection master
drop tables t2, t1;

--echo # Replication: master new, slave old
--connection master
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
--sync_slave_with_master
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
--connection master
alter table t1 rename column x to y, algorithm=inplace;
alter table t2 rename column x to y, algorithm=inplace;
--sync_slave_with_master
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
show create table t2;
--connection master
drop tables t2, t1;

--echo # Replication: master old, slave old
--connection master
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
--sync_slave_with_master
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create table t1(x int primary key) engine innodb;
create table t2(x int references t1(x)) engine innodb;
set session debug_dbug= "+d,fk_create_legacy_storage";
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'x', 'x');";
set session debug_dbug= @saved_debug_dbug;
--connection master
alter table t1 rename column x to y, algorithm=inplace;
alter table t2 rename column x to y, algorithm=inplace;
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
show create table t2;
--sync_slave_with_master
--source include/wait_all_purged.inc
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign;
--error ER_BAD_TABLE_ERROR
select * from information_schema.innodb_sys_foreign_cols;
show create table t2;
set global innodb_eval_sql= default;
--connection master
drop tables t2, t1;
set global innodb_eval_sql= default;
--source include/rpl_end.inc

--enable_warnings
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql= default;
set default_storage_engine= default;
